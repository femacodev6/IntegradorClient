<h5 class="m-0">Reporte de tardanzas</h5>
<p-toolbar styleClass="mb-6">
    <ng-template #start>
        <p-button class="mr-2" label="Mes anterior" (onClick)="setMesAnterior()">
        </p-button>
        <p-button class="mr-2" label="Este mes" (onClick)="setMesActual()">
        </p-button>
        <p-floatlabel variant="on" class="mr-2">
            <p-datepicker [(ngModel)]="fechaInicio" />
            <label for="on_label">Fecha Inicio</label>
        </p-floatlabel>
        <p-floatlabel variant="on" class="mr-2">
            <p-datepicker [(ngModel)]="fechaFin" />
            <label for="on_label">Fecha Fin</label>
        </p-floatlabel>
        <p-button label="Ver tardanzas" severity="info" class="mr-2" (onClick)="loadDemoData()" />
    </ng-template>
</p-toolbar>

<div class="card" [style]="{'padding':'1em'}">
    <div class="mb-2 flex items-center justify-between flex-wrap">
        <!-- izquierda: selects y total -->
        <div class="flex items-center flex-wrap gap-2">
            <p-select [options]="turnos()" [(ngModel)]="turnoSelected" optionLabel="nombre" optionValue="nombre"
                [checkmark]="true" [showClear]="true" placeholder="Selecione un turno" class="mr-2 w-full md:w-56">
                <ng-template let-turno #item>
                    <span class="mr-2">
                        {{turno.nombre}}
                    </span>
                    <p-badge [value]="turno.cantidad" severity="secondary" badgeSize="small" />
                </ng-template>
            </p-select>

            <p-select [options]="comparacionsCantidad()" [(ngModel)]="comparacionSelected" optionLabel="nombre"
                optionValue="id" [checkmark]="true" [showClear]="true" placeholder="Selecione una comparación"
                class="mr-2 w-full md:w-56">
                <ng-template let-comparacion #item>
                    <p-tag [value]="comparacion.nombre" [severity]="comparacion.severity" class="mr-2" />
                    <p-badge [value]="comparacion.cantidad" severity="secondary" badgeSize="small" />
                </ng-template>
            </p-select>

            <span class="mr-2">{{totalColaboradores()}} colaboradores</span>
        </div>

        <!-- derecha: botón y contador alineados a la derecha -->
        <div class="flex items-center space-x-2">
            @if(isInicioFinMes()==true){
            <p-button label="Traspasar" severity="warn" class="mr-2" (onClick)="atrazoToBukVolcar()" />
            <span>{{selectedTardanzas?.length || 0}} seleccionados</span>
            }
        </div>
    </div>

    <p-table [value]="tardanzasGrupoFilter()" dataKey="identificacion" [tableStyle]="{ 'min-width': '60rem' }"
        [expandedRowKeys]="expandedRows" showGridlines [(selection)]="selectedTardanzas">

        <ng-template #header>
            <tr>
                <th style="width: 5rem"></th>
                <th style="width: 3rem">
                    <p-tableHeaderCheckbox />
                </th>
                <th pSortableColumn="identificacion">
                    <div class="flex items-center gap-2">
                        Identificacion
                        <p-sortIcon field="identificacion" />
                    </div>
                </th>
                <th pSortableColumn="nombre">
                    <div class="flex items-center gap-2">
                        Nombre
                        <p-sortIcon field="nombre" />
                    </div>
                </th>
                <th pSortableColumn="apellidos">
                    <div class="flex items-center gap-2">
                        Apellidos
                        <p-sortIcon field="apellidos" />
                    </div>
                </th>
                <th pSortableColumn="turnos">
                    <div class="flex items-center gap-2">
                        Turnos
                        <p-sortIcon field="turnos" />
                    </div>
                </th>
                <th pSortableColumn="totalAtraso">
                    <div class="flex items-center gap-2">
                        Atrazo Inngresa
                        <p-sortIcon field="totalAtraso" />
                    </div>
                </th>
                <th>
                    Atrazo Buk Acum. {{mes()}}
                </th>
                <th>
                    Comparación
                </th>
            </tr>
        </ng-template>
        <ng-template #body let-groupedTardanza let-expanded="expanded">
            <tr>
                <td>
                    <p-button type="button" pRipple [pRowToggler]="groupedTardanza" [text]="true" severity="secondary"
                        [rounded]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
                </td>
                <td style="width: 3rem">
                    <p-tableCheckbox [value]="groupedTardanza" />
                </td>
                <td>{{ groupedTardanza.identificacion }}</td>
                <td>{{ groupedTardanza.nombre}}</td>
                <td>{{ groupedTardanza.apellidos}}</td>
                <td> @for (turno of groupedTardanza.turnos; track $index) {
                    <p-chip [label]="turno" />
                    }
                </td>
                <td>{{ groupedTardanza.totalAtraso | minutesToFriendly }}</td>
                <td>{{ groupedTardanza.tardanzasBuk()?.hours | hoursToFriendly }}</td>
                <td><p-tag [value]="groupedTardanza.comparacion.nombre"
                        [severity]="groupedTardanza.comparacion.severity" /></td>
            </tr>
        </ng-template>
        <ng-template #expandedrow let-groupedTardanza let-rowIndex="rowIndex">
            <tr>
                <td colspan="8">
                    <div class="p-4">
                        <p-table #dt [value]="groupedTardanza.tardanzas" showGridlines="false" [rows]="10"
                            [columns]="cols" [paginator]="false"
                            [globalFilterFields]="['name', 'country.name', 'representative.name', 'status']"
                            [tableStyle]="{ 'min-width': '100%' }" [(selection)]="selectedTardanzas" [rowHover]="true"
                            dataKey="id">
                            <ng-template #header>
            <tr>
                <th pSortableColumn="dia">
                    Turno
                    <p-sortIcon field="dia" />
                </th>
                <th pSortableColumn="dia">
                    Dia
                    <p-sortIcon field="dia" />
                </th>
                <th pSortableColumn="entrada">
                    Entrada
                    <p-sortIcon field="entrada" />
                </th>
                <th pSortableColumn="entrada_real">
                    Entrada real
                    <p-sortIcon field="entrada_real" />
                </th>
                <th pSortableColumn="atraso">
                    Atraso
                    <p-sortIcon field="atraso" />
                </th>
            </tr>
        </ng-template>
        <ng-template #body let-tardanza>
            <tr>
                <td>{{ tardanza.turno }}</td>
                <td>{{ tardanza.dia }}</td>
                <td>{{ tardanza.entrada }}</td>
                <td>{{ tardanza.entradaReal }}</td>
                <td>{{ tardanza.atraso | minutesToFriendly }} </td>

            </tr>
        </ng-template>
    </p-table>
</div>

@if(isInicioFinMes()==true){
<div class="p-4" style="display: flex; flex-direction: column;">
    <div style="flex: 1;">
        <!-- Aquí va tu contenido -->

    </div>
    <div style="display: flex; justify-content: flex-end;">
        <p-button label="Traspasar" severity="warn" class="mr-2" (onClick)="atrazoToBuk(rowIndex,groupedTardanza)" />
    </div>
</div>
}
</td>
</tr>
</ng-template>
</p-table>
</div>